{"ast":null,"code":"var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { getBytes, getLines, getMessages } from './parse';\nexport const EventStreamContentType = 'text/event-stream';\nconst DefaultRetryInterval = 1000;\nconst LastEventId = 'last-event-id';\nexport function fetchEventSource(input, _a) {\n  var {\n      signal: inputSignal,\n      headers: inputHeaders,\n      onopen: inputOnOpen,\n      onmessage,\n      onclose,\n      onerror,\n      openWhenHidden,\n      fetch: inputFetch\n    } = _a,\n    rest = __rest(_a, [\"signal\", \"headers\", \"onopen\", \"onmessage\", \"onclose\", \"onerror\", \"openWhenHidden\", \"fetch\"]);\n  return new Promise((resolve, reject) => {\n    const headers = Object.assign({}, inputHeaders);\n    if (!headers.accept) {\n      headers.accept = EventStreamContentType;\n    }\n    let curRequestController;\n    function onVisibilityChange() {\n      curRequestController.abort();\n      if (!document.hidden) {\n        create();\n      }\n    }\n    if (!openWhenHidden) {\n      document.addEventListener('visibilitychange', onVisibilityChange);\n    }\n    let retryInterval = DefaultRetryInterval;\n    let retryTimer = 0;\n    function dispose() {\n      document.removeEventListener('visibilitychange', onVisibilityChange);\n      window.clearTimeout(retryTimer);\n      curRequestController.abort();\n    }\n    inputSignal === null || inputSignal === void 0 ? void 0 : inputSignal.addEventListener('abort', () => {\n      dispose();\n      resolve();\n    });\n    const fetch = inputFetch !== null && inputFetch !== void 0 ? inputFetch : window.fetch;\n    const onopen = inputOnOpen !== null && inputOnOpen !== void 0 ? inputOnOpen : defaultOnOpen;\n    async function create() {\n      var _a;\n      curRequestController = new AbortController();\n      try {\n        const response = await fetch(input, Object.assign(Object.assign({}, rest), {\n          headers,\n          signal: curRequestController.signal\n        }));\n        await onopen(response);\n        await getBytes(response.body, getLines(getMessages(id => {\n          if (id) {\n            headers[LastEventId] = id;\n          } else {\n            delete headers[LastEventId];\n          }\n        }, retry => {\n          retryInterval = retry;\n        }, onmessage)));\n        onclose === null || onclose === void 0 ? void 0 : onclose();\n        dispose();\n        resolve();\n      } catch (err) {\n        if (!curRequestController.signal.aborted) {\n          try {\n            const interval = (_a = onerror === null || onerror === void 0 ? void 0 : onerror(err)) !== null && _a !== void 0 ? _a : retryInterval;\n            window.clearTimeout(retryTimer);\n            retryTimer = window.setTimeout(create, interval);\n          } catch (innerErr) {\n            dispose();\n            reject(innerErr);\n          }\n        }\n      }\n    }\n    create();\n  });\n}\nfunction defaultOnOpen(response) {\n  const contentType = response.headers.get('content-type');\n  if (!(contentType === null || contentType === void 0 ? void 0 : contentType.startsWith(EventStreamContentType))) {\n    throw new Error(`Expected content-type to be ${EventStreamContentType}, Actual: ${contentType}`);\n  }\n}","map":{"version":3,"names":["getBytes","getLines","getMessages","EventStreamContentType","DefaultRetryInterval","LastEventId","fetchEventSource","input","_a","signal","inputSignal","headers","inputHeaders","onopen","inputOnOpen","onmessage","onclose","onerror","openWhenHidden","fetch","inputFetch","rest","__rest","Promise","resolve","reject","Object","assign","accept","curRequestController","onVisibilityChange","abort","document","hidden","create","addEventListener","retryInterval","retryTimer","dispose","removeEventListener","window","clearTimeout","defaultOnOpen","AbortController","response","body","id","retry","err","aborted","interval","setTimeout","innerErr","contentType","get","startsWith","Error"],"sources":["../../src/fetch.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}